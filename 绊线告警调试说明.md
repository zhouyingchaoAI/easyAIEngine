# 绊线告警调试说明

## 问题诊断

如果绊线统计服务没有上传告警，按以下步骤排查：

---

## 🔍 步骤1：检查服务是否运行

```bash
# 检查进程
ps aux | grep algorithm_service_line_crossing

# 检查端口
curl http://localhost:7903/health

# 应该返回：
# {"status": "healthy", ...}
```

---

## 🔍 步骤2：查看日志

```bash
# 实时查看日志
tail -f /cv_space/predict/logs/line_crossing.log

# 或通过Web界面查看
# http://localhost:7901
# 选择"绊线统计日志"
```

**关键日志信息：**
```
✓ 检测到新穿越: 0 → 1 (+1)，触发告警  ← 应该看到这个
   返回结果: total_count=2, person_count=1

ℹ️  无新穿越（累计=1），不触发告警但保留检测信息  ← 或这个
   返回结果: total_count=2, 无person_count
```

---

## 🔍 步骤3：检查配置文件

绊线统计**必须**有 `algo_config.json` 配置文件。

**检查配置文件是否存在：**
```bash
# 查看已保存的配置
ls -l /cv_space/predict/configs/*_algo_config.json

# 查看配置内容
cat /cv_space/predict/configs/厕所统计_algo_config.json
```

**配置文件要求：**
```json
{
  "task_id": "门禁统计",
  "task_type": "绊线人数统计",  ← 必须是这个
  "regions": [
    {
      "id": "line_1",
      "type": "line",          ← 必须是 line
      "enabled": true,
      "points": [[0.5, 0], [0.5, 1]],
      "properties": {
        "direction": "both"    ← in/out/both
      }
    }
  ]
}
```

---

## 🔍 步骤4：理解告警逻辑

### 当前告警机制（增量告警）

```
时刻 T1: 有人但未穿越 → total_count=2, 无person_count → 上游看到检测但不告警
时刻 T2: 1人穿越绊线  → total_count=2, person_count=1  → 上游触发告警 ✅
时刻 T3: 有人但未穿越 → total_count=2, 无person_count → 上游看到检测但不告警
时刻 T4: 2人穿越绊线  → total_count=3, person_count=2  → 上游触发告警 ✅
```

**关键点：**
- ✅ 始终返回检测信息（total_count, objects）
- ✅ 只有新穿越时才设置 person_count
- ✅ person_count 的存在与否决定是否触发告警

---

## 🔍 步骤5：手动测试

### 发送测试请求

```bash
# 发送推理请求
curl -X POST http://localhost:7903/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://10.1.6.230:9000/images/绊线人数统计/厕所统计/test.jpg",
    "task_id": "厕所统计",
    "task_type": "绊线人数统计"
  }'
```

**预期返回（有新穿越）：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 2,
    "person_count": 1,  ← 有这个字段
    "line_crossing": {
      "line_1": {"count": 15}
    }
  }
}
```

**预期返回（无新穿越）：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 2,
    // 无 person_count 字段
    "line_crossing": {
      "line_1": {"count": 15}
    }
  }
}
```

---

## 🔍 步骤6：检查上游系统

### 上游系统应该如何判断告警？

```python
# 上游系统判断逻辑（伪代码）
response = call_algorithm_service(image_url)

if response['success']:
    result = response['result']
    
    # 方式1：根据 person_count 判断（推荐）
    if 'person_count' in result and result['person_count'] > 0:
        trigger_alarm(result['person_count'])  # 触发告警
    
    # 方式2：根据 total_count 判断（不推荐用于绊线）
    if result['total_count'] > 0:
        # 这个会一直触发告警，不适合绊线统计
        trigger_alarm(result['total_count'])
```

**关键：上游系统需要检查 `person_count` 字段是否存在！**

---

## 🛠️ 常见问题

### Q1: 为什么一直显示"无新穿越"？

**可能原因：**
1. 没有人真的穿越绊线
2. 跟踪器没有正确工作
3. 绊线位置配置不正确

**解决方案：**
```bash
# 查看日志，检查是否有跟踪器
grep "跟踪器更新" /cv_space/predict/logs/line_crossing.log

# 查看是否有绊线检测
grep "绊线检测\|坐标转换" /cv_space/predict/logs/line_crossing.log

# 查看累积计数
grep "累加" /cv_space/predict/logs/line_crossing.log
```

---

### Q2: person_count 一直是0？

**检查返回结果中是否有 person_count 字段：**
```bash
# 查看日志
grep "返回结果" /cv_space/predict/logs/line_crossing.log | tail -10
```

如果看到：
- `返回结果: total_count=2, person_count=1` ← 正常，有告警
- `返回结果: total_count=2, 无person_count` ← 正常，无新穿越

如果完全没有 person_count 字段，说明没有检测到新穿越。

---

### Q3: 累积计数不增长？

**检查绊线检测逻辑：**
```bash
# 查看绊线统计日志
grep "绊线统计.*跨线" /cv_space/predict/logs/line_crossing.log

# 应该看到类似：
# [绊线统计] ID:123 跨线 line_1 (in) -> 累加: 15
```

如果没有这个日志，说明：
1. 没有人穿越绊线
2. 绊线位置配置不正确
3. 跟踪器没有正确追踪目标

---

### Q4: 如何重置累积计数？

累积计数会在以下情况重置：
1. 服务重启
2. 24小时自动清零
3. 手动重启服务

```bash
# 重启绊线服务（重置累积计数）
./停止所有服务.sh
./start_line_crossing_service.sh
```

---

## 📊 调试检查清单

- [ ] 服务正在运行（端口 7903）
- [ ] 配置文件存在且格式正确
- [ ] task_type 是 "绊线人数统计"
- [ ] regions 中有 type="line" 的配置
- [ ] 检测到物体（objects 不为空）
- [ ] 跟踪器正在工作（日志中有"跟踪器更新"）
- [ ] 绊线位置配置合理
- [ ] 有人真的穿越了绊线
- [ ] 上游系统正确处理 person_count 字段

---

## 🔧 强制触发告警测试

### 方法1：重启服务重置计数

```bash
# 1. 停止服务
./停止所有服务.sh

# 2. 重新启动
./start_line_crossing_service.sh

# 3. 发送请求
# 第一次有人穿越一定会触发告警（因为计数从0变成1）
```

### 方法2：修改代码临时调试

在 `algorithm_service_line_crossing.py` 中临时添加：

```python
# 在检测到穿越后，强制触发告警
if total_crossed >= 0:  # 总是为True
    result_data['person_count'] = 1  # 强制设置
    print(f"  🔧 调试模式：强制触发告警")
```

---

## 📝 完整调试流程

```bash
# 1. 查看服务状态
curl http://localhost:7903/health

# 2. 查看最新日志
tail -50 /cv_space/predict/logs/line_crossing.log

# 3. 搜索关键信息
grep -E "检测到新穿越|无新穿越|返回结果" /cv_space/predict/logs/line_crossing.log | tail -20

# 4. 检查配置文件
ls -l /cv_space/predict/configs/

# 5. 发送测试请求并查看返回
curl -X POST http://localhost:7903/infer -H "Content-Type: application/json" -d '...'

# 6. 如果仍有问题，查看详细日志
./manage_logs.sh view line
```

---

## 💡 预期日志输出

### 正常工作时的日志

```
收到推理请求 [14:30:15]
  任务ID: 厕所统计
  任务类型: 绊线人数统计
  🔍 尝试加载配置文件: http://...
  ✓ 成功加载配置文件
  📋 配置内容: task_id=厕所统计, regions=1
  
批量推理完成: 27ms
  [绊线检测] 坐标转换: [0.4, 0.1] -> (768, 108), [0.4, 0.9] -> (768, 972)
  [绊线统计] ID:5 跨线 line_1 (in) -> 累加: 15
  
  ✓ 检测到新穿越: 14 → 15 (+1)，触发告警
     返回结果: total_count=2, person_count=1  ← 关键！
  
推理完成: 总耗时 60ms
```

---

Happy debugging! 🔧

