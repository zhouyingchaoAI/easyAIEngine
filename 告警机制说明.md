# 算法服务告警机制说明

## 两种服务的告警机制

### 1. 实时检测服务（algorithm_service.py）

#### 端口
- **8501**

#### 任务类型
- 人数统计
- 客流分析
- 人头检测

#### 告警机制：**实时告警**
- **每次检测都返回当前结果**
- 只要检测到物体，就会触发告警
- 适合需要实时监控的场景

#### 返回结果示例

**有人在场：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 5,
    "person_count": 5  // 实时人数
  }
}
```

**无人在场：**
```json
{
  "success": true,
  "result": {
    "objects": [],
    "total_count": 0,
    "person_count": 0
  }
}
```

#### 特点
- ✅ **简单直接** - 有人就告警
- ✅ **实时响应** - 每次推理都返回结果
- ✅ **无需配置** - 不需要额外配置文件（可选配置区域过滤）

---

### 2. 绊线统计服务（algorithm_service_line_crossing.py）

#### 端口
- **8502**

#### 任务类型
- 绊线人数统计

#### 告警机制：**增量告警**
- **只在发生新穿越时才返回告警**
- 穿越计数累加，但只有新增穿越时才触发告警
- 无新穿越时返回空结果，不触发告警

#### 返回结果示例

**发生新穿越（触发告警）：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 2,
    "person_count": 1,  // 新增穿越人数（触发告警）
    "line_crossing": {
      "line_1": {
        "region_name": "进门线",
        "count": 15,  // 累计穿越总数
        "direction": "both"
      }
    }
  }
}
```

**无新穿越（不触发告警）：**
```json
{
  "success": true,
  "result": {
    "objects": [],      // 空数组
    "total_count": 0    // 0
    // 无 person_count 和 line_crossing
  }
}
```

#### 特点
- ✅ **增量告警** - 只在有新穿越时告警
- ✅ **累积计数** - 记录总穿越人数（24小时自动清零）
- ✅ **避免重复** - 同一时段多次推理不会重复告警
- ⚠️ **需要配置** - 必须提供 algo_config.json

---

## 告警触发条件对比

| 场景 | 实时检测服务 | 绊线统计服务 |
|------|------------|------------|
| **检测到人但无动作** | ✅ 触发告警 | ❌ 不告警（返回空） |
| **有人穿越绊线** | ✅ 触发告警 | ✅ 触发告警 |
| **穿越后持续检测** | ✅ 持续告警 | ❌ 不告警（返回空） |
| **下次有新穿越** | ✅ 触发告警 | ✅ 触发告警 |

---

## 工作流程对比

### 实时检测服务流程

```
时刻 T1: 检测到 3 人 → 返回 person_count=3 → 触发告警
时刻 T2: 检测到 3 人 → 返回 person_count=3 → 触发告警
时刻 T3: 检测到 5 人 → 返回 person_count=5 → 触发告警
时刻 T4: 检测到 0 人 → 返回 person_count=0 → 不告警（或告警为0）
```

**特点：每次都返回实时结果**

---

### 绊线统计服务流程

```
时刻 T1: 有人但未穿越 → 返回 total_count=0 → 不告警 ❌
时刻 T2: 1人穿越绊线 → 累计=1 → 返回 person_count=1 → 触发告警 ✅
时刻 T3: 有人但未穿越 → 累计=1 → 返回 total_count=0 → 不告警 ❌
时刻 T4: 2人穿越绊线 → 累计=3 → 返回 person_count=2 → 触发告警 ✅
时刻 T5: 有人但未穿越 → 累计=3 → 返回 total_count=0 → 不告警 ❌
```

**特点：只在穿越时告警，累计统计保持增长**

---

## 如何选择服务

### 使用实时检测服务的场景
1. **人数监控** - 实时监控房间/区域内有多少人
2. **客流统计** - 统计当前客流量
3. **占用检测** - 检测区域是否有人占用
4. **异常检测** - 检测禁入区域是否有人

### 使用绊线统计服务的场景
1. **进出门禁** - 统计进出某个区域的人数
2. **跨线计数** - 统计穿越某条线的人数
3. **累积统计** - 需要累积计数的场景（如一天进出多少人）
4. **减少误报** - 不希望同一个人被多次告警

---

## 配置示例

### 实时检测服务配置（可选）

**如需区域过滤：**
```json
{
  "task_id": "人数统计",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "area_1",
      "name": "检测区域",
      "type": "rectangle",
      "enabled": true,
      "points": [[0.1, 0.1], [0.9, 0.9]]
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5
  }
}
```

### 绊线统计服务配置（必需）

```json
{
  "task_id": "门禁统计",
  "task_type": "绊线人数统计",
  "regions": [
    {
      "id": "line_1",
      "name": "进门线",
      "type": "line",
      "enabled": true,
      "points": [[0.5, 0.0], [0.5, 1.0]],
      "properties": {
        "direction": "both"
      }
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5,
    "iou_threshold": 0.5
  }
}
```

---

## 常见问题

### Q1: 为什么绊线服务有时候返回空结果？
**A**: 这是正常行为。绊线服务只在**发生新穿越时**才返回有效结果。如果没有新穿越，会返回空结果以避免重复告警。

### Q2: 我需要实时知道区域内有多少人，应该用哪个服务？
**A**: 使用**实时检测服务**（端口 8501），它会每次都返回当前检测到的人数。

### Q3: 我需要统计一天内进出多少人，应该用哪个服务？
**A**: 使用**绊线统计服务**（端口 8502），它会累积统计穿越人数（24小时自动清零）。

### Q4: 实时检测服务会不会重复告警？
**A**: 会的。只要区域内有人，每次推理都会返回结果。上游系统需要自行处理重复告警的逻辑。

### Q5: 绊线服务的累积计数什么时候清零？
**A**: 每24小时自动清零一次。

### Q6: 可以同时运行两个服务吗？
**A**: 可以！它们使用不同的端口（8501 和 8502），互不干扰。

---

## 启动服务

```bash
# 启动实时检测服务（端口 8501）
./start_algorithm_service.sh

# 启动绊线统计服务（端口 8502）
./start_line_crossing_service.sh
```

---

## 技术支持

如有问题，请查看：
- [服务说明.md](服务说明.md) - 服务功能详细说明
- [配置参数说明.md](配置参数说明.md) - 配置文件参数说明
- [绊线增量告警说明.md](绊线增量告警说明.md) - 绊线算法详细说明


