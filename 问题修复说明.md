# 问题修复说明

## 修复内容

### ✅ 问题1：绊线统计服务无法停止

**原因：**
- 进程在独立的进程组中运行
- 简单的 terminate() 无法停止所有子进程

**修复方案：**
1. 改进了 `algorithm_manager.py` 的停止逻辑
2. 使用递归杀死子进程
3. 添加 pkill 作为备份方案
4. 创建了便捷的停止脚本 `停止所有服务.sh`

**现在可以：**
```bash
# 方式1：通过Web界面停止
# 访问 http://localhost:7901
# 点击"⏹️ 停止服务"按钮

# 方式2：使用停止脚本
./停止所有服务.sh

# 方式3：手动杀进程
pkill -f algorithm_service_line_crossing.py
```

---

### ✅ 问题2：绊线统计算法没有上传告警

**原因：**
- 之前的逻辑在无新穿越时返回空结果（total_count=0, objects=[]）
- 上游系统认为没有检测到物体，因此不推送任何信息

**修复方案：**
修改了告警逻辑，现在的行为是：

**✅ 有新穿越时（触发告警）：**
```json
{
  "objects": [...],
  "total_count": 2,
  "person_count": 1,  ← 有这个字段，上游触发告警
  "line_crossing": {...}
}
```

**✅ 无新穿越时（不触发告警，但保留检测信息）：**
```json
{
  "objects": [...],
  "total_count": 2,
  // 无 person_count 字段，上游不触发告警但能看到检测结果
  "line_crossing": {...}
}
```

**核心改变：**
- ✅ 始终保留检测信息（objects, total_count）
- ✅ 只有新穿越时才设置 person_count
- ✅ 上游系统能看到检测结果，但只在有 person_count 时才触发告警

---

## 📋 告警逻辑总结

### 实时检测服务（端口 7902）
```
每次都返回：
{
  "objects": [...],
  "total_count": 5,
  "person_count": 5  ← 总是有
}
→ 上游每次都收到告警
```

### 绊线统计服务（端口 7903）
```
有新穿越：
{
  "objects": [...],
  "total_count": 2,
  "person_count": 1  ← 只在新穿越时有
}
→ 上游收到告警

无新穿越：
{
  "objects": [...],
  "total_count": 2,
  // 无 person_count
}
→ 上游不触发告警
```

---

## 🔍 如何验证修复

### 1. 测试停止功能

```bash
# 启动绊线服务
./start_line_crossing_service.sh

# 检查进程
ps aux | grep algorithm_service_line_crossing

# 通过Web界面停止
# 访问 http://localhost:7901
# 点击"⏹️ 停止服务"

# 再次检查进程（应该没有了）
ps aux | grep algorithm_service_line_crossing
```

### 2. 测试告警功能

```bash
# 1. 启动服务
./start_line_crossing_service.sh

# 2. 查看日志
tail -f /cv_space/predict/logs/line_crossing.log

# 3. 等待有人穿越绊线

# 4. 查看日志输出
# 应该看到：
#   ✓ 检测到新穿越: 0 → 1 (+1)，触发告警
#      返回结果: total_count=2, person_count=1
```

---

## 🛠️ 新增工具

### 1. 停止所有服务脚本
```bash
./停止所有服务.sh
```
- 一键停止所有算法服务
- 支持强制停止
- 检查残留进程

### 2. 日志管理脚本
```bash
./manage_logs.sh view line      # 查看绊线日志
./manage_logs.sh stats          # 日志统计
./manage_logs.sh search "穿越"  # 搜索日志
```

### 3. 调试说明文档
- `绊线告警调试说明.md` - 详细的调试步骤

---

## 📊 验证清单

完成以下检查确保一切正常：

**停止功能：**
- [ ] Web界面可以停止实时检测服务
- [ ] Web界面可以停止绊线统计服务
- [ ] 停止后进程完全消失
- [ ] 可以重新启动服务

**告警功能：**
- [ ] 有人穿越时返回 person_count
- [ ] 无穿越时不返回 person_count
- [ ] total_count 始终反映检测到的物体数
- [ ] 上游系统能正确处理告警

---

## 🎯 下一步

### 如果告警仍然不工作：

1. **检查配置文件**
   ```bash
   cat /cv_space/predict/configs/厕所统计_algo_config.json
   ```
   确认 task_type 是 "绊线人数统计"

2. **查看详细日志**
   ```bash
   ./manage_logs.sh view line
   ```
   查找是否有"检测到新穿越"的日志

3. **检查上游系统**
   - 确认上游系统检查 person_count 字段
   - 而不是只检查 total_count

4. **重置计数器测试**
   ```bash
   # 停止服务
   ./停止所有服务.sh
   
   # 重新启动（计数器重置为0）
   ./start_line_crossing_service.sh
   
   # 第一次穿越一定会触发告警
   ```

---

## 📞 需要帮助？

查看以下文档：
- [绊线告警调试说明.md](绊线告警调试说明.md) - 详细调试步骤
- [日志管理说明.md](日志管理说明.md) - 日志查看方法
- [告警机制说明.md](告警机制说明.md) - 告警机制详解

---

修复完成！🎉

