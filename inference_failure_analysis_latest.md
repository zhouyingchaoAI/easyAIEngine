# 推理失败问题排查报告（最新）

**排查时间**: 2025-11-13 14:35:00  
**日志文件**: /code/predict/logs/realtime_detector.log (611595行)

## 📊 统计数据

### 最近5000行日志统计
- **总推理请求数**: 2,289 次
- **成功请求数**: 2,273 次 (200状态码)
- **失败请求数**: 3 次 (500状态码)
- **失败率**: **0.13%** ✅

### 错误类型分布
- **HTTP Error 404: Not Found**: 100% 的失败都是此错误

## 🔍 问题分析

### 1. 根本原因：图片不存在或URL路径问题

**典型错误URL分析**：
```
图片文件名: 20251113-143424.474.jpg
签名时间: 2025-11-13 06:34:37 (X-Amz-Date=20251113T063437Z)
签名有效期: 36000秒 (10小时)
签名过期时间: 2025-11-13 16:34:37
实际请求时间: 2025-11-13 14:34:54
```

**问题时间线**：
- 图片生成时间：2025-11-13 14:34:24
- URL签名时间：2025-11-13 06:34:37（**提前8小时签名，可能是UTC时间**）
- 签名过期时间：2025-11-13 16:34:37
- 实际请求时间：2025-11-13 14:34:54
- **重要发现**：URL签名实际上**未过期**（还有约1小时才过期），但仍然返回404
- **真正原因**：图片可能不存在，或者URL路径/权限问题

### 2. 问题特征

1. **URL签名时间异常**：
   - 图片在14:34生成，但URL签名时间是06:34
   - 签名时间比图片生成时间早8小时
   - 说明URL是在图片生成前就预生成的

2. **签名有效期已增加**：
   - 当前有效期：36000秒（10小时）
   - 比之前的1小时有所改善
   - 但仍然存在时间不匹配问题

3. **失败率极低**：
   - 失败率仅0.13%
   - 说明大部分请求都成功
   - 只有极少数URL过期导致失败

### 3. 影响范围

- **任务ID**: "厕所2", "无人测试3"
- **受影响实例**: 7913, 7922
- **失败模式**: 偶发性失败，主要是URL签名时间问题

## 🎯 问题根源

### 存储服务问题
1. **图片不存在**：
   - URL签名未过期，但返回404
   - 说明图片可能已被删除或从未上传
   - 或者图片路径不正确

2. **URL路径问题**：
   - 图片文件名：20251113-143424.474.jpg
   - 但URL中可能路径不匹配
   - 需要检查MinIO/S3中的实际文件路径

3. **访问权限问题**：
   - 虽然URL签名有效，但可能没有访问权限
   - 或者存储桶策略限制了访问

### 上游系统问题
1. **URL预生成机制**：
   - URL在图片生成前就预生成并签名
   - 签名时间与图片生成时间不匹配（相差8小时，可能是UTC时间）

2. **时间同步问题**：
   - 签名时间（06:34 UTC）与图片生成时间（14:34 CST）相差8小时
   - 这是正常的时区差异，不是问题

3. **图片上传验证缺失**：
   - 上游系统在发送推理请求前未验证图片是否已成功上传
   - 未检查图片是否存在

## 💡 解决方案

### 立即处理（高优先级）

1. **检查图片是否存在**：
   - 验证MinIO/S3中图片是否已成功上传
   - 检查图片路径是否正确
   - 确认图片文件是否被删除

2. **检查存储服务访问权限**：
   - 验证URL签名是否有访问权限
   - 检查存储桶策略
   - 确认访问凭证是否正确

3. **添加图片上传验证**：
   - 在发送推理请求前验证图片是否存在
   - 如果图片不存在，不要发送推理请求
   - 或者实现图片上传重试机制

### 短期优化（低优先级）

1. **添加URL有效性检查**：
   - 在发送推理请求前检查URL是否过期
   - 如果过期，自动刷新URL签名

2. **错误重试机制**：
   - 当遇到404错误时，尝试重新获取URL
   - 或者从其他源获取图片

3. **监控告警**：
   - 对404错误设置告警阈值
   - 当失败率超过1%时触发告警

## 📈 当前状态

- ✅ **推理服务正常运行**（未崩溃）
- ✅ **错误处理机制正常**（正确捕获并返回500响应）
- ✅ **失败率极低**（0.13%）
- ✅ **大部分请求成功**（99.87%）
- ⚠️ **仍有少量404错误**（URL签名时间问题）

## 🔧 建议的修复步骤

### 步骤1：检查上游系统时间同步
```bash
# 检查系统时间
date
# 检查时区
timedatectl status
# 检查UTC时间
date -u
```

### 步骤2：验证URL生成逻辑
- 确认URL签名时间与图片生成时间的关系
- 检查是否有时间同步问题
- 确认时区设置是否正确

### 步骤3：临时解决方案
- 增加URL签名有效期到24小时
- 添加URL有效性检查
- 实现URL自动刷新机制

### 步骤4：长期优化
- 修复URL生成逻辑，确保签名时间正确
- 实现实时URL生成（图片生成后立即生成URL）
- 添加URL有效性预检查

## 📝 其他发现

1. **配置文件访问问题**：
   - 配置文件不存在（状态码: 403）
   - 不影响推理功能
   - 服务使用默认配置

2. **区域过滤功能正常**：
   - 日志显示区域过滤正常工作
   - 能够正确过滤区域内的物体

## 🎯 优先级总结

1. **🟡 中优先级**: 修复URL生成逻辑，解决时间同步问题
2. **🟢 低优先级**: 增加URL签名有效期到24小时
3. **🟢 低优先级**: 添加URL有效性检查和监控告警

---

**结论**: 推理服务运行**基本正常**，失败率极低（0.13%）。主要问题是URL签名时间与图片生成时间不匹配，导致少量请求失败。建议修复上游系统的URL生成逻辑和时间同步问题。

**报告生成时间**: 2025-11-13 14:35:00

