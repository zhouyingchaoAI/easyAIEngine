# 📋 日志管理说明

## 日志系统概述

完善的日志系统为每个服务提供独立的日志文件，支持日志查看、过滤、清空等功能。

---

## 📁 日志文件结构

```
/cv_space/predict/logs/
├── manager.log                  # Web管理界面日志
├── realtime_detector.log        # 实时检测服务日志
├── line_crossing.log            # 绊线统计服务日志
├── realtime_detector_YYYYMMDD.log   # 每日归档日志
└── line_crossing_YYYYMMDD.log       # 每日归档日志
```

---

## 🎯 日志功能

### 1. 独立日志文件
- ✅ 每个服务有独立的日志文件
- ✅ 互不干扰，便于问题排查
- ✅ 自动创建日志目录

### 2. 日志轮转
- ✅ 单个日志文件最大 10MB
- ✅ 自动轮转，保留最近5个备份
- ✅ 每日自动创建归档日志

### 3. 日志级别
- 🔵 **DEBUG** - 详细调试信息
- 🟢 **INFO** - 一般信息
- 🟡 **WARNING** - 警告信息
- 🔴 **ERROR** - 错误信息
- 🟣 **CRITICAL** - 严重错误

### 4. 日志格式
```
2025-10-22 14:30:15 [INFO] [main:123] 服务启动成功
│                    │       │         └── 日志消息
│                    │       └── 函数名和行号
│                    └── 日志级别
└── 时间戳
```

---

## 🌐 Web界面日志查看

### 功能特性

1. **日志过滤**
   - 全部日志 - 查看所有服务的日志
   - 管理器日志 - 只看管理界面日志
   - 实时检测日志 - 只看实时检测服务日志
   - 绊线统计日志 - 只看绊线统计服务日志

2. **行数选择**
   - 50行 - 快速查看
   - 100行 - 默认（推荐）
   - 200行 - 详细查看
   - 500行 - 深度排查

3. **日志高亮**
   - 🔴 **ERROR/失败** - 红色背景
   - 🟡 **WARNING/警告** - 橙色背景
   - 🟢 **INFO/成功** - 绿色左边框

4. **操作按钮**
   - 🔄 **刷新** - 手动刷新日志
   - 🗑️ **清空** - 清空当前选择的日志

---

## 💻 命令行查看日志

### 实时查看日志（tail）

```bash
# 实时查看实时检测服务日志
tail -f /cv_space/predict/logs/realtime_detector.log

# 实时查看绊线统计服务日志
tail -f /cv_space/predict/logs/line_crossing.log

# 实时查看管理器日志
tail -f /cv_space/predict/logs/manager.log

# 同时查看所有日志
tail -f /cv_space/predict/logs/*.log
```

### 查看最近N行

```bash
# 查看最近100行
tail -n 100 /cv_space/predict/logs/realtime_detector.log

# 查看最近500行
tail -n 500 /cv_space/predict/logs/line_crossing.log
```

### 搜索日志

```bash
# 搜索错误日志
grep -i "error" /cv_space/predict/logs/*.log

# 搜索特定任务ID
grep "task_id" /cv_space/predict/logs/realtime_detector.log

# 搜索推理时间
grep "推理完成" /cv_space/predict/logs/*.log
```

### 统计日志

```bash
# 统计日志行数
wc -l /cv_space/predict/logs/*.log

# 统计文件大小
du -h /cv_space/predict/logs/

# 查看日志文件信息
ls -lh /cv_space/predict/logs/
```

---

## 🔧 日志管理

### 清空日志

**通过Web界面：**
1. 访问 http://localhost:7901
2. 在日志区域选择要清空的日志
3. 点击"🗑️ 清空"按钮
4. 确认操作

**通过命令行：**
```bash
# 清空特定日志
> /cv_space/predict/logs/realtime_detector.log

# 清空所有日志
> /cv_space/predict/logs/manager.log
> /cv_space/predict/logs/realtime_detector.log
> /cv_space/predict/logs/line_crossing.log

# 或使用脚本
find /cv_space/predict/logs -name "*.log" -type f -exec truncate -s 0 {} \;
```

### 备份日志

```bash
# 备份到归档目录
mkdir -p /cv_space/predict/logs/archive
cp /cv_space/predict/logs/*.log /cv_space/predict/logs/archive/

# 带时间戳备份
tar -czf logs_backup_$(date +%Y%m%d_%H%M%S).tar.gz /cv_space/predict/logs/
```

### 清理旧日志

```bash
# 删除7天前的日志
find /cv_space/predict/logs -name "*.log" -type f -mtime +7 -delete

# 删除归档日志（保留最近30天）
find /cv_space/predict/logs -name "*_202*.log" -type f -mtime +30 -delete
```

---

## 📊 日志内容示例

### 实时检测服务日志

```
2025-10-22 14:30:15 [INFO] 服务启动: GPU=0, 端口=7902
2025-10-22 14:30:20 [INFO] 收到推理请求: task_id=测试统计
2025-10-22 14:30:20 [INFO] 批量推理完成: 27ms
2025-10-22 14:30:20 [INFO] 区域过滤: 原始 8 个 → 区域内 5 个
2025-10-22 14:30:20 [INFO] 推理完成: 总耗时 60ms
```

### 绊线统计服务日志

```
2025-10-22 14:31:00 [INFO] 服务启动: GPU=1, 端口=7903
2025-10-22 14:31:05 [INFO] 收到推理请求: task_id=门禁统计
2025-10-22 14:31:05 [INFO] 跟踪器更新: 当前 3 个活跃跟踪器
2025-10-22 14:31:05 [INFO] 检测到新穿越: 10 → 11 (+1)，触发告警
2025-10-22 14:31:08 [INFO] 无新穿越（累计=11），返回空结果
```

### 管理器日志

```
2025-10-22 14:29:00 [INFO] 算法服务管理器启动
2025-10-22 14:29:00 [INFO] 管理界面: http://0.0.0.0:7901
2025-10-22 14:30:15 [INFO] 启动服务: realtime (GPU=0, 端口=7902)
2025-10-22 14:31:00 [INFO] 启动服务: line_crossing (GPU=1, 端口=7903)
```

---

## 🎨 Web界面日志特性

### 日志高亮

```css
🔴 红色 - ERROR、失败、异常
   2025-10-22 14:30:20 [ERROR] 推理失败: CUDA out of memory

🟡 橙色 - WARNING、警告
   2025-10-22 14:30:20 [WARNING] GPU显存使用率过高: 85%

🟢 绿色 - INFO、成功
   2025-10-22 14:30:20 [INFO] 推理完成: 总耗时 60ms
```

### 自动滚动
- 加载日志后自动滚动到最新
- 便于查看最新日志

### 实时更新
- 可以设置自动刷新
- 或手动点击刷新按钮

---

## 🔍 日志分析技巧

### 1. 性能分析

```bash
# 统计推理耗时
grep "推理完成" /cv_space/predict/logs/realtime_detector.log | tail -100

# 查找慢请求（>100ms）
grep "推理完成" /cv_space/predict/logs/*.log | grep -E "[1-9][0-9]{2,}ms"

# 统计批处理大小
grep "批大小" /cv_space/predict/logs/*.log
```

### 2. 错误排查

```bash
# 查找所有错误
grep -i "error\|失败\|exception" /cv_space/predict/logs/*.log

# 查找CUDA错误
grep -i "cuda\|gpu\|out of memory" /cv_space/predict/logs/*.log

# 查找最近的错误（带上下文）
grep -i -C 3 "error" /cv_space/predict/logs/realtime_detector.log | tail -50
```

### 3. 统计分析

```bash
# 统计请求数
grep "收到推理请求" /cv_space/predict/logs/*.log | wc -l

# 统计成功/失败次数
grep "推理完成" /cv_space/predict/logs/*.log | wc -l
grep "推理失败" /cv_space/predict/logs/*.log | wc -l

# 按小时统计请求
grep "收到推理请求" /cv_space/predict/logs/realtime_detector.log | \
  awk '{print $2}' | cut -d':' -f1 | sort | uniq -c
```

---

## 🛠️ 日志维护

### 定期清理脚本

创建定时任务清理旧日志：

```bash
# 编辑crontab
crontab -e

# 添加以下行（每天凌晨3点清理7天前的日志）
0 3 * * * find /cv_space/predict/logs -name "*.log" -type f -mtime +7 -delete
```

### 日志压缩

```bash
# 压缩旧日志
gzip /cv_space/predict/logs/*_202410*.log

# 解压查看
zcat /cv_space/predict/logs/realtime_detector_20241022.log.gz | less
```

### 日志归档

```bash
#!/bin/bash
# 归档脚本

LOG_DIR="/cv_space/predict/logs"
ARCHIVE_DIR="/cv_space/predict/logs/archive"
DATE=$(date +%Y%m%d)

mkdir -p "$ARCHIVE_DIR"

# 归档昨天的日志
tar -czf "$ARCHIVE_DIR/logs_$DATE.tar.gz" \
  "$LOG_DIR"/*.log \
  --exclude="$LOG_DIR/archive/*"

echo "日志已归档: logs_$DATE.tar.gz"
```

---

## 📈 日志监控

### 监控日志增长

```bash
# 监控日志文件大小
watch -n 5 'ls -lh /cv_space/predict/logs/*.log'

# 监控日志行数增长
watch -n 5 'wc -l /cv_space/predict/logs/*.log'
```

### 监控错误率

```bash
# 统计最近1小时的错误
grep "$(date +%Y-%m-%d\ %H)" /cv_space/predict/logs/*.log | \
  grep -i error | wc -l
```

---

## 🎯 最佳实践

### 1. 日志级别选择
- **开发环境**: DEBUG（记录所有信息）
- **生产环境**: INFO（记录重要信息）
- **问题排查**: DEBUG（临时开启详细日志）

### 2. 日志大小控制
- 单个日志文件 < 100MB
- 总日志大小 < 1GB
- 定期清理或归档旧日志

### 3. 日志保留策略
- 当前日志：始终保留
- 每日归档：保留30天
- 压缩归档：保留90天
- 超过90天：删除

---

## 🔧 常用操作

### 快速查看最新日志

```bash
# 方式1：通过Web界面
# 访问 http://localhost:7901
# 选择服务和行数，点击刷新

# 方式2：通过命令行
tail -f /cv_space/predict/logs/realtime_detector.log
```

### 搜索特定内容

```bash
# 搜索某个任务ID的所有日志
grep "task_id=测试统计" /cv_space/predict/logs/*.log

# 搜索某个时间段的日志
grep "2025-10-22 14:3" /cv_space/predict/logs/realtime_detector.log
```

### 导出日志

```bash
# 导出今天的所有日志
grep "$(date +%Y-%m-%d)" /cv_space/predict/logs/*.log > today_logs.txt

# 导出错误日志
grep -i "error" /cv_space/predict/logs/*.log > error_logs.txt
```

---

## 📊 日志统计示例

### 生成日志报告

```bash
#!/bin/bash
# 日志统计报告

echo "=========================================="
echo "  日志统计报告 - $(date +%Y-%m-%d)"
echo "=========================================="
echo ""

for log in /cv_space/predict/logs/*.log; do
    if [ -f "$log" ]; then
        echo "文件: $(basename $log)"
        echo "  大小: $(du -h $log | cut -f1)"
        echo "  行数: $(wc -l < $log)"
        echo "  错误: $(grep -c -i error $log 2>/dev/null || echo 0)"
        echo "  警告: $(grep -c -i warning $log 2>/dev/null || echo 0)"
        echo ""
    fi
done
```

---

## 🚨 告警监控

### 监控错误日志

```bash
# 实时监控错误（有错误时立即显示）
tail -f /cv_space/predict/logs/*.log | grep --color=always -i error

# 错误计数告警
ERROR_COUNT=$(grep -i error /cv_space/predict/logs/*.log | wc -l)
if [ $ERROR_COUNT -gt 10 ]; then
    echo "警告: 检测到 $ERROR_COUNT 个错误！"
fi
```

---

## 🎁 推荐工具

### 1. 日志查看工具

```bash
# lnav - 强大的日志查看工具
sudo apt-get install lnav
lnav /cv_space/predict/logs/*.log

# multitail - 多窗口日志查看
sudo apt-get install multitail
multitail /cv_space/predict/logs/*.log
```

### 2. 日志分析工具

```bash
# goaccess - Web日志分析
# logwatch - 系统日志监控
# elk stack - 企业级日志分析（Elasticsearch + Logstash + Kibana）
```

---

## 📝 日志文件说明

### manager.log
**内容**: Web管理界面操作日志
- 启动/停止服务操作
- API请求记录
- 系统事件

### realtime_detector.log
**内容**: 实时检测服务运行日志
- 推理请求和结果
- 性能统计
- 区域过滤信息
- 错误和警告

### line_crossing.log
**内容**: 绊线统计服务运行日志
- 跟踪器状态
- 绊线检测结果
- 穿越事件记录
- 累积计数更新

---

## 🎯 日志使用场景

### 场景1：服务启动失败
```bash
# 查看最新日志
tail -100 /cv_space/predict/logs/realtime_detector.log

# 查找错误信息
grep -i error /cv_space/predict/logs/realtime_detector.log | tail -10
```

### 场景2：性能分析
```bash
# 统计平均推理时间
grep "推理完成" /cv_space/predict/logs/realtime_detector.log | \
  grep -oP '\d+ms' | sed 's/ms//' | \
  awk '{sum+=$1; count++} END {print "平均:", sum/count, "ms"}'
```

### 场景3：告警排查
```bash
# 查看绊线事件
grep "检测到新穿越" /cv_space/predict/logs/line_crossing.log

# 查看告警历史
grep "触发告警\|不触发告警" /cv_space/predict/logs/*.log | tail -50
```

---

## 💡 小技巧

### 1. 彩色日志查看
```bash
# 使用ccze工具
tail -f /cv_space/predict/logs/realtime_detector.log | ccze -A

# 或使用grep高亮
tail -f /cv_space/predict/logs/*.log | grep --color=always -E "ERROR|WARNING|INFO|$"
```

### 2. 日志过滤
```bash
# 只看INFO日志
grep "\[INFO\]" /cv_space/predict/logs/realtime_detector.log

# 排除DEBUG日志
grep -v "\[DEBUG\]" /cv_space/predict/logs/realtime_detector.log
```

### 3. 时间范围查询
```bash
# 查看14:30-14:40的日志
sed -n '/2025-10-22 14:30/,/2025-10-22 14:40/p' \
  /cv_space/predict/logs/realtime_detector.log
```

---

## 🔐 日志安全

### 1. 权限控制
```bash
# 设置日志目录权限
chmod 750 /cv_space/predict/logs
chown -R your_user:your_group /cv_space/predict/logs
```

### 2. 敏感信息过滤
日志中自动过滤敏感信息：
- ✅ 不记录完整URL（可能包含token）
- ✅ 不记录用户凭证
- ✅ 不记录内部IP地址

---

## 📚 相关文档

- [WEB管理界面使用说明.md](WEB管理界面使用说明.md) - Web界面使用
- [端口配置.md](端口配置.md) - 端口配置说明
- [快速开始.md](快速开始.md) - 快速启动指南

---

Happy logging! 📋✨

