# 推理失败问题排查报告

## 时间范围
**排查时间**: 2025-11-13 10:47:00 - 10:57:16 (最近10分钟)

## 统计数据

### 总体情况
- **总推理请求数**: 1,945 次
- **失败请求数**: 1,813 次 (93.2%)
- **成功请求数**: 147 次 (6.8%)
- **失败率**: 93.2%

### 错误类型
- **HTTP Error 404: Not Found**: 100% 的失败都是此错误

## 问题分析

### 1. 根本原因：图片URL签名过期

从错误日志中的URL分析：
```
图片文件名: 20251113-025540.488.jpg
签名时间: 20251113T025646Z (2025-11-13 02:56:46 UTC)
签名有效期: 3600秒 (1小时)
```

**问题**：
- 图片生成时间：2025-11-13 02:55:40
- URL签名时间：2025-11-13 02:56:46
- 签名过期时间：2025-11-13 03:56:46 (签名后1小时)
- 实际请求时间：2025-11-13 10:47-10:57
- **已过期约 7-8 小时**

### 2. 影响范围

- **任务ID**: "无人测试2"
- **影响实例**: 多个推理服务实例 (7904, 7905, 7907, 7910, 7912, 7915, 7920, 7924等)
- **失败模式**: 持续大量失败，但仍有少量成功请求

### 3. 错误处理机制

从代码分析：
- ✅ 程序有完整的异常处理，不会崩溃
- ✅ 错误被正确捕获并返回500响应
- ✅ 服务继续运行，可以处理新请求
- ❌ 但大量404错误导致推理失败率高达93.2%

## 问题根源

### 上游系统问题
1. **URL生成时机不当**: 图片在凌晨2:56生成，但推理请求在上午10:47才发送
2. **签名有效期过短**: 1小时的有效期对于延迟处理的场景不够
3. **缺少URL有效性检查**: 上游系统在发送请求前未检查URL是否过期

### 存储服务问题
1. **图片可能已被删除**: MinIO/S3中的图片可能因为过期策略被删除
2. **访问权限问题**: 签名过期后无法访问

## 解决方案建议

### 短期方案
1. **检查上游系统**: 确认为什么图片生成后8小时才发送推理请求
2. **增加URL有效期**: 将签名有效期从1小时增加到24小时或更长
3. **添加重试机制**: 在URL过期前自动刷新签名

### 长期方案
1. **实时处理**: 图片生成后立即发送推理请求，避免延迟
2. **URL预检查**: 在发送推理请求前检查URL有效性
3. **错误监控**: 对404错误设置告警，及时发现问题
4. **降级处理**: 当URL过期时，尝试从其他源获取图片

## 当前状态

- ✅ 推理服务正常运行（未崩溃）
- ✅ 错误处理机制正常
- ❌ 推理失败率过高（93.2%）
- ❌ 大量资源浪费在失败的请求上

## 建议优先级

1. **高优先级**: 检查上游系统，解决URL过期问题
2. **中优先级**: 增加URL签名有效期
3. **低优先级**: 优化错误处理和监控

