# 算法告警信息格式说明

**更新日期：** 2025-11-06  
**更新内容：** 添加图片URL和任务ID字段

---

## 返回格式说明

所有算法服务的推理响应现在都包含以下新增字段：

- **`image_url`**: 请求的图片URL，便于追溯告警来源
- **`task_id`**: 任务ID，用于关联任务配置

---

## 实时检测服务（端口 7902）

### 成功响应示例

```json
{
  "success": true,
  "result": {
    "objects": [
      {
        "class": "head",
        "confidence": 0.85,
        "bbox": [250.5, 180.2, 280.3, 220.8]
      },
      {
        "class": "head",
        "confidence": 0.92,
        "bbox": [350.1, 200.5, 380.7, 240.2]
      }
    ],
    "total_count": 2,
    "person_count": 2
  },
  "confidence": 0.885,
  "inference_time_ms": 120.5,
  "total_time_ms": 245.3,
  "image_url": "http://192.168.1.100:8080/images/camera1/frame_001.jpg",
  "task_id": "人数统计_会议室A"
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 是否成功 |
| `result` | object | 检测结果 |
| `result.objects` | array | 检测到的对象列表 |
| `result.total_count` | int | 对象总数 |
| `result.person_count` | int | 人数（人数统计任务） |
| `confidence` | float | 平均置信度 |
| `inference_time_ms` | float | 推理时间（毫秒） |
| `total_time_ms` | float | 总处理时间（毫秒） |
| **`image_url`** | **string** | **请求的图片URL** ⭐ 新增 |
| **`task_id`** | **string** | **任务ID** ⭐ 新增 |

### 错误响应示例

```json
{
  "success": false,
  "error": "下载图片失败: Connection timeout",
  "confidence": 0.0,
  "inference_time_ms": 0,
  "total_time_ms": 1523.8,
  "image_url": "http://192.168.1.100:8080/images/camera1/frame_001.jpg",
  "task_id": "人数统计_会议室A"
}
```

---

## 绊线统计服务（端口 7903）

### 成功响应示例（有新穿越）

```json
{
  "success": true,
  "result": {
    "objects": [
      {
        "class": "head",
        "confidence": 0.88,
        "bbox": [300.2, 250.5, 330.8, 290.3]
      }
    ],
    "total_count": 1,
    "person_count": 1,
    "line_crossing": {
      "line_1": {
        "region_name": "进门线",
        "count": 15,
        "direction": "both"
      }
    }
  },
  "confidence": 0.88,
  "inference_time_ms": 135.2,
  "total_time_ms": 180.5,
  "image_url": "http://192.168.1.100:8080/images/gate1/frame_002.jpg",
  "task_id": "门禁统计_大门"
}
```

### 成功响应示例（无新穿越）

```json
{
  "success": true,
  "result": {
    "objects": [],
    "total_count": 0
  },
  "confidence": 0.0,
  "inference_time_ms": 128.3,
  "total_time_ms": 165.7,
  "image_url": "http://192.168.1.100:8080/images/gate1/frame_003.jpg",
  "task_id": "门禁统计_大门"
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 是否成功 |
| `result` | object | 检测结果 |
| `result.objects` | array | 检测到的对象列表 |
| `result.total_count` | int | 对象总数 |
| `result.person_count` | int | 新穿越人数（仅有新穿越时） |
| `result.line_crossing` | object | 绊线统计信息（仅有新穿越时） |
| `confidence` | float | 平均置信度 |
| `inference_time_ms` | float | 推理时间（毫秒） |
| `total_time_ms` | float | 总处理时间（毫秒） |
| **`image_url`** | **string** | **请求的图片URL** ⭐ 新增 |
| **`task_id`** | **string** | **任务ID** ⭐ 新增 |

### 错误响应示例

```json
{
  "success": false,
  "error": "绊线人数统计必须有配置文件",
  "confidence": 0.0,
  "inference_time_ms": 0,
  "total_time_ms": 25.6,
  "image_url": "http://192.168.1.100:8080/images/gate1/frame_004.jpg",
  "task_id": "门禁统计_大门"
}
```

---

## 使用场景

### 1. 告警追溯

通过 `image_url` 可以快速找到触发告警的原始图片：

```python
# 收到告警
alert = {
    "success": true,
    "result": {"person_count": 5},
    "image_url": "http://192.168.1.100:8080/images/camera1/frame_123.jpg",
    "task_id": "人数统计_会议室A"
}

# 下载图片进行复查
import requests
response = requests.get(alert['image_url'])
with open('alert_image.jpg', 'wb') as f:
    f.write(response.content)
```

### 2. 任务管理

通过 `task_id` 关联任务配置和统计信息：

```python
# 按任务ID统计告警
alerts_by_task = {}
for alert in alerts:
    task_id = alert['task_id']
    if task_id not in alerts_by_task:
        alerts_by_task[task_id] = []
    alerts_by_task[task_id].append(alert)

# 输出统计
for task_id, task_alerts in alerts_by_task.items():
    print(f"{task_id}: {len(task_alerts)} 个告警")
```

### 3. 日志记录

完整的告警信息便于日志记录和分析：

```python
import logging
import json

logger = logging.getLogger('alert_system')

# 记录告警
alert = response.json()
logger.info(
    f"告警触发 - 任务: {alert['task_id']}, "
    f"人数: {alert['result'].get('person_count', 0)}, "
    f"图片: {alert['image_url']}"
)

# 保存完整告警数据
with open('alerts.jsonl', 'a') as f:
    f.write(json.dumps(alert, ensure_ascii=False) + '\n')
```

### 4. 实时展示

在前端展示告警时，可以直接显示图片：

```javascript
// 收到告警推送
socket.on('alert', (data) => {
  console.log(`任务 ${data.task_id} 触发告警`);
  console.log(`图片URL: ${data.image_url}`);
  
  // 在页面显示告警图片
  const img = document.createElement('img');
  img.src = data.image_url;
  img.alt = `告警 - ${data.task_id}`;
  document.getElementById('alert-container').appendChild(img);
  
  // 显示告警信息
  const info = document.createElement('div');
  info.textContent = `检测到 ${data.result.person_count} 人`;
  document.getElementById('alert-container').appendChild(info);
});
```

---

## 兼容性说明

### 向后兼容

✅ **完全兼容**

新增的 `image_url` 和 `task_id` 字段不会影响现有系统：

- 如果现有系统不使用这些字段，可以忽略
- 字段始终存在，不会出现字段缺失的情况
- 即使发生错误，这些字段也会正确返回

### API版本

- **当前版本：** v2.3.0
- **新增字段：** `image_url`, `task_id`
- **修改时间：** 2025-11-06

---

## 测试示例

### 实时检测服务测试

```bash
# 发送推理请求
curl -X POST http://localhost:7902/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://192.168.1.100:8080/images/test.jpg",
    "task_id": "测试任务_001",
    "task_type": "人数统计"
  }'

# 预期返回包含 image_url 和 task_id
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 3,
    "person_count": 3
  },
  "confidence": 0.85,
  "inference_time_ms": 120.5,
  "total_time_ms": 245.3,
  "image_url": "http://192.168.1.100:8080/images/test.jpg",
  "task_id": "测试任务_001"
}
```

### 绊线统计服务测试

```bash
# 发送推理请求
curl -X POST http://localhost:7903/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://192.168.1.100:8080/images/gate/test.jpg",
    "task_id": "测试门禁_001",
    "task_type": "绊线人数统计"
  }'

# 预期返回包含 image_url 和 task_id
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 1,
    "person_count": 1,
    "line_crossing": {...}
  },
  "confidence": 0.88,
  "inference_time_ms": 135.2,
  "total_time_ms": 180.5,
  "image_url": "http://192.168.1.100:8080/images/gate/test.jpg",
  "task_id": "测试门禁_001"
}
```

---

## 错误处理

### 缺少 image_url

```json
{
  "success": false,
  "error": "缺少image_url参数",
  "confidence": 0.0,
  "inference_time_ms": 0,
  "total_time_ms": 2.5,
  "image_url": "",
  "task_id": "unknown"
}
```

### 请求解析失败

```json
{
  "success": false,
  "error": "JSON decode error",
  "confidence": 0.0,
  "inference_time_ms": 0,
  "total_time_ms": 1.2,
  "image_url": "",
  "task_id": "unknown"
}
```

---

## 注意事项

### 1. 字段类型

- `image_url`: 始终为字符串类型，错误时返回空字符串 `""`
- `task_id`: 始终为字符串类型，未指定时返回 `"unknown"`

### 2. 编码

- 所有JSON响应使用 UTF-8 编码
- 中文字段正常显示，不需要额外解码

### 3. 性能

- 添加这两个字段对性能几乎没有影响
- 不增加额外的处理时间

---

## 相关文档

- **告警机制说明.md** - 告警机制详细说明
- **区域过滤配置示例.md** - 区域过滤功能
- **配置参数说明.md** - 配置参数详细说明

---

## 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v2.3.0 | 2025-11-06 | 添加 `image_url` 和 `task_id` 字段 |
| v2.2.0 | 2025-11-06 | 添加区域过滤功能 |
| v2.1.0 | 2025-11-05 | 优化推理性能 |
| v2.0.0 | 2025-11-04 | 重构服务架构 |

---

**状态：** ✅ 已实现并部署  
**兼容性：** ✅ 向后兼容  
**文档完整性：** ✅ 完整

