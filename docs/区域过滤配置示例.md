# 算法区域过滤配置说明

## 功能说明

算法告警返回结果现在支持**区域过滤**功能。只有位于配置区域内的检测对象才会被返回，区域外的对象将被自动过滤掉。

## 支持的服务

### 1. 实时检测服务（algorithm_service.py）
- 端口：7902
- 任务类型：人数统计、客流分析、人头检测
- ✅ 已支持区域过滤

### 2. 绊线统计服务（algorithm_service_line_crossing.py）
- 端口：7903
- 任务类型：绊线人数统计
- ✅ 已支持区域过滤

## 区域类型

支持以下几种区域类型：

### 1. 矩形区域（rectangle）
使用两个点定义：左上角和右下角

### 2. 多边形区域（polygon）
使用多个点定义多边形的顶点（至少3个点）

### 3. 绊线区域（line）
仅用于绊线统计服务，用于跨线检测

## 配置文件格式

配置文件应命名为 `algo_config.json`，与图片放在同一目录下。

### 示例1：矩形区域过滤（实时检测服务）

```json
{
  "task_id": "人数统计_区域1",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "area_1",
      "name": "监控区域",
      "type": "rectangle",
      "enabled": true,
      "points": [
        [0.2, 0.2],
        [0.8, 0.8]
      ]
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5
  }
}
```

**说明：**
- `points`: 两个点，第一个是左上角 `[x1, y1]`，第二个是右下角 `[x2, y2]`
- 坐标支持归一化（0-1）或像素坐标

### 示例2：多边形区域过滤（实时检测服务）

```json
{
  "task_id": "人数统计_多边形",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "area_1",
      "name": "不规则监控区域",
      "type": "polygon",
      "enabled": true,
      "points": [
        [0.1, 0.1],
        [0.5, 0.05],
        [0.9, 0.3],
        [0.8, 0.9],
        [0.2, 0.85]
      ]
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5
  }
}
```

**说明：**
- `points`: 多个点定义多边形顶点（至少3个点）
- 坐标按顺序连接形成封闭多边形

### 示例3：多个区域过滤（实时检测服务）

```json
{
  "task_id": "人数统计_多区域",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "area_1",
      "name": "区域1",
      "type": "rectangle",
      "enabled": true,
      "points": [[0.1, 0.1], [0.4, 0.5]]
    },
    {
      "id": "area_2",
      "name": "区域2",
      "type": "rectangle",
      "enabled": true,
      "points": [[0.6, 0.5], [0.9, 0.9]]
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5
  }
}
```

**说明：**
- 可以定义多个区域
- 只要对象在**任意一个**区域内，就会被保留
- 可以通过 `enabled` 字段控制区域是否启用

### 示例4：绊线统计 + 区域过滤（绊线统计服务）

```json
{
  "task_id": "门禁统计_区域过滤",
  "task_type": "绊线人数统计",
  "regions": [
    {
      "id": "detection_area",
      "name": "检测区域",
      "type": "rectangle",
      "enabled": true,
      "points": [[0.3, 0.2], [0.7, 0.8]]
    },
    {
      "id": "line_1",
      "name": "进门线",
      "type": "line",
      "enabled": true,
      "points": [[0.5, 0.0], [0.5, 1.0]],
      "properties": {
        "direction": "both"
      }
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5,
    "iou_threshold": 0.3
  }
}
```

**说明：**
- 绊线统计服务支持同时配置检测区域和绊线
- `rectangle`/`polygon` 类型用于区域过滤
- `line` 类型用于绊线检测
- **先进行区域过滤，再进行跟踪和绊线检测**

## 工作流程

### 实时检测服务流程

```
1. 模型推理 → 检测到所有对象
2. 置信度过滤 → 过滤低置信度对象
3. 区域过滤 → 只保留配置区域内的对象  ← 新增功能
4. 返回结果 → 返回过滤后的对象列表
```

### 绊线统计服务流程

```
1. 模型推理 → 检测到所有对象
2. 置信度过滤 → 过滤低置信度对象
3. 区域过滤 → 只保留配置区域内的对象  ← 新增功能
4. 目标跟踪 → 跟踪区域内的对象
5. 绊线检测 → 检测跟踪对象是否跨线
6. 增量告警 → 只在有新穿越时返回告警
7. 返回结果 → 返回告警信息
```

## 坐标系统

### 归一化坐标（推荐）

坐标值在 0-1 之间，相对于图片尺寸：

```json
{
  "points": [
    [0.0, 0.0],  // 左上角
    [1.0, 1.0]   // 右下角
  ]
}
```

**优点：**
- 与图片分辨率无关
- 配置文件可复用

### 像素坐标

坐标值大于1，表示实际像素位置：

```json
{
  "points": [
    [100, 100],    // 像素 (100, 100)
    [800, 600]     // 像素 (800, 600)
  ]
}
```

**注意：** 系统会自动识别坐标类型

## 过滤规则

### 判断标准

使用对象的**中心点**判断是否在区域内：

```
对象中心点 = (bbox[0] + bbox[2]) / 2, (bbox[1] + bbox[3]) / 2
```

### 多区域逻辑

当配置多个区域时：
- 对象只要在**任意一个**区域内，就会被保留
- 使用 OR 逻辑（并集）

### 禁用区域

可以通过 `enabled` 字段临时禁用某个区域：

```json
{
  "id": "area_1",
  "enabled": false,  // 禁用此区域
  "type": "rectangle",
  "points": [[0.1, 0.1], [0.9, 0.9]]
}
```

## 返回结果示例

### 有区域过滤的情况

**请求日志：**
```
收到推理请求 [10:30:15]
  任务ID: 人数统计_区域1
  任务类型: 人数统计
--------------------------------------------------------
  🔍 尝试加载配置文件: http://.../.../algo_config.json
  ✓ 成功加载配置文件
  📋 配置内容: task_id=人数统计_区域1, regions=1
  ℹ️  区域过滤: 原始 8 个 → 区域内 5 个 (过滤掉 3 个)
  推理完成: 120ms, 总耗时 245ms
========================================================
```

**返回结果：**
```json
{
  "success": true,
  "result": {
    "objects": [
      {
        "class": "head",
        "confidence": 0.85,
        "bbox": [250.5, 180.2, 280.3, 220.8]
      },
      // ... 4 more objects (区域内的对象)
    ],
    "total_count": 5,      // 区域内对象数量
    "person_count": 5
  },
  "confidence": 0.82,
  "inference_time_ms": 120.5,
  "total_time_ms": 245.3
}
```

### 无区域过滤的情况

如果没有配置文件或没有配置区域，则返回所有检测对象（无过滤）：

```json
{
  "success": true,
  "result": {
    "objects": [
      // ... 8 objects (所有检测到的对象)
    ],
    "total_count": 8,      // 所有对象数量
    "person_count": 8
  },
  "confidence": 0.78,
  "inference_time_ms": 120.5,
  "total_time_ms": 245.3
}
```

## 配置文件放置位置

配置文件应与图片放在同一目录下：

```
/path/to/images/
  ├── algo_config.json    ← 配置文件
  ├── frame_001.jpg
  ├── frame_002.jpg
  └── ...
```

**推理请求示例：**

```bash
curl -X POST http://localhost:7902/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://example.com/path/to/images/frame_001.jpg",
    "task_id": "人数统计_区域1",
    "task_type": "人数统计"
  }'
```

系统会自动从以下URL加载配置：
```
http://example.com/path/to/images/algo_config.json
```

## 使用场景

### 1. 排除无关区域

在人数统计中，排除走廊、门口等无关区域，只统计房间内的人数。

### 2. 多区域监控

同时监控多个独立区域，如多个会议室、多个工位等。

### 3. 提高准确性

减少误检：排除远处、边缘等容易误检的区域。

### 4. 减少告警

通过区域限制，减少不必要的告警，降低告警频率。

### 5. 隐私保护

排除敏感区域，如卫生间、休息室等，不进行检测和统计。

## 性能影响

区域过滤的性能开销极小：

- **算法复杂度：** O(n×m)，n是对象数量，m是区域数量
- **额外耗时：** < 1ms（通常情况下）
- **内存开销：** 可忽略不计

## 常见问题

### Q1: 如果没有配置文件会怎样？
**A:** 不会报错，系统会返回所有检测到的对象（无区域过滤）。

### Q2: 可以同时使用矩形和多边形区域吗？
**A:** 可以，可以在同一个配置文件中混合使用不同类型的区域。

### Q3: 区域过滤会影响绊线检测吗？
**A:** 会的。区域过滤在跟踪之前进行，只有区域内的对象才会被跟踪和检测跨线。

### Q4: 如果对象部分在区域内，部分在区域外呢？
**A:** 以对象的中心点为准。如果中心点在区域内，则保留；否则过滤掉。

### Q5: 坐标可以是负数或大于1吗？
**A:** 
- 归一化坐标应在 0-1 之间
- 像素坐标可以是任意正数
- 负数坐标不推荐使用

### Q6: 多个区域是"与"还是"或"的关系？
**A:** "或"的关系。对象只要在任意一个区域内就会被保留。

## 测试建议

1. **先不配置区域**：验证基础检测功能是否正常
2. **配置单个矩形区域**：验证区域过滤是否生效
3. **逐步调整区域范围**：优化区域配置
4. **配置多个区域**：验证多区域逻辑
5. **测试边界情况**：对象刚好在区域边界的情况

## 配置工具推荐

可以使用以下工具辅助配置区域：

1. **图片标注工具**：labelImg, LabelMe等
2. **在线画图工具**：获取精确坐标
3. **视频播放器**：查看当前帧坐标

## 技术支持

如有问题，请查看：
- [服务说明.md](服务说明.md)
- [配置参数说明.md](配置参数说明.md)
- [告警机制说明.md](告警机制说明.md)

---

**更新日期：** 2025-11-06
**功能状态：** ✅ 已实现并测试

