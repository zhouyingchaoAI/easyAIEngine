# 打包说明

本文档说明如何将算法服务打包成可执行程序。

## 前置要求

1. **Python环境**: Python 3.7+
2. **系统依赖**: 
   - 昇腾ACL库（如果使用昇腾硬件加速）
   - OpenCV相关库（通常通过pip安装）

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 执行打包

```bash
# 打包所有服务
./build.sh

# 或只打包特定服务
./build.sh --manager-only          # 只打包管理器
./build.sh --service-only          # 只打包实时检测服务
./build.sh --line-crossing-only    # 只打包绊线统计服务
```

### 3. 查找可执行文件

打包完成后，可执行文件位于 `dist/` 目录：

- `dist/algorithm_manager` - 算法服务管理器
- `dist/algorithm_service` - 实时检测服务
- `dist/algorithm_service_line_crossing` - 绊线统计服务

## 使用打包后的可执行文件

### 算法服务管理器

```bash
./dist/algorithm_manager
```

访问管理界面: http://localhost:7900

### 实时检测服务

```bash
./dist/algorithm_service --port 7902 --gpu-id 0
```

### 绊线统计服务

```bash
./dist/algorithm_service_line_crossing --port 7903 --gpu-id 0
```

## 打包配置说明

项目包含三个PyInstaller配置文件：

- `build_manager.spec` - 管理器打包配置
- `build_service.spec` - 实时检测服务打包配置
- `build_line_crossing.spec` - 绊线统计服务打包配置

### 已包含的资源

打包时会自动包含以下资源：

- `configs/` - 配置文件目录
- `weight/` - 模型权重文件
- Python依赖库

### 注意事项

1. **系统架构**: 打包的可执行文件只能在相同架构的系统上运行（当前系统: `$(uname -m)`）

2. **昇腾ACL库**: 
   - 昇腾ACL库（`acl`）是系统级库，无法打包进可执行文件
   - 目标机器需要单独安装昇腾ACL库
   - 如果目标机器没有昇腾硬件，需要修改代码使用其他推理后端

3. **OpenCV**: 
   - OpenCV的某些功能可能需要系统库支持
   - 如果遇到问题，可能需要安装额外的系统库

4. **文件大小**: 
   - 打包后的可执行文件会比较大（通常几十MB到几百MB）
   - 这是因为包含了Python解释器和所有依赖

## 高级配置

### 修改打包配置

如果需要修改打包选项，可以编辑对应的 `.spec` 文件：

```python
# 示例：添加额外的数据文件
datas=[
    ('configs', 'configs'),
    ('weight', 'weight'),
    ('your_data', 'your_data'),  # 添加自定义数据
],

# 示例：添加隐藏导入
hiddenimports=[
    'your_module',
],
```

### 单文件 vs 单目录模式

当前配置使用单文件模式（`onefile`），所有内容打包成一个可执行文件。

如果需要单目录模式（启动更快），可以修改 `.spec` 文件，将 `EXE` 改为 `COLLECT`：

```python
# 单目录模式
coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='algorithm_manager',
)
```

## 故障排除

### 问题1: 打包失败

**症状**: PyInstaller报错

**解决方案**:
- 检查所有依赖是否已安装
- 查看错误信息，可能需要添加 `hiddenimports`
- 确保所有Python文件语法正确

### 问题2: 可执行文件无法运行

**症状**: 运行时提示缺少模块或库

**解决方案**:
- 检查目标系统架构是否匹配
- 确认昇腾ACL库是否已安装（如果使用）
- 查看错误日志，添加缺失的 `hiddenimports`

### 问题3: 找不到模型文件

**症状**: 运行时提示模型文件不存在

**解决方案**:
- 确认 `weight/` 目录已包含在打包配置中
- 检查模型文件路径是否正确
- 可能需要使用绝对路径或相对路径调整

## 性能优化

1. **使用UPX压缩**: 配置文件已启用UPX压缩，可以减小文件大小
2. **排除不需要的模块**: 在 `.spec` 文件的 `excludes` 中添加不需要的模块
3. **单目录模式**: 如果启动速度更重要，使用单目录模式

## 相关文档

- [PyInstaller官方文档](https://pyinstaller.org/)
- [快速开始.md](./快速开始.md)
- [服务说明.md](./服务说明.md)

