# 绊线告警规则说明

## 🎯 核心规则

**绊线统计服务只有在发生穿越且累积计数变化时才上传告警**

---

## 📊 返回结果规则

### ✅ 有新穿越（上传告警）

**条件：**
- 累积计数 > 上次记录的计数

**返回结果：**
```json
{
  "success": true,
  "result": {
    "objects": [人1, 人2],      ← 有检测结果
    "total_count": 2,           ← 检测到的物体数
    "person_count": 1,          ← 新增穿越人数（关键字段）
    "line_crossing": {
      "line_1": {
        "count": 15,            ← 累积总数
        "direction": "both"
      }
    }
  }
}
```

**上游系统行为：**
- ✅ 看到 person_count = 1
- ✅ 触发告警："检测到1人穿越绊线"

---

### ❌ 无新穿越（不上传告警）

**条件：**
- 累积计数 == 上次记录的计数（没有变化）

**返回结果：**
```json
{
  "success": true,
  "result": {
    "objects": [],              ← 空数组
    "total_count": 0            ← 0
    // 无 person_count 字段
    // 无 line_crossing 字段
  }
}
```

**上游系统行为：**
- ❌ total_count = 0，认为没有检测到任何东西
- ❌ 不触发告警

---

## 🔄 完整工作流程

```
时刻 T1: 有2人在场，但都没有穿越绊线
  ├─ 检测: objects=2人
  ├─ 跟踪: trackers=2个
  ├─ 绊线: 无人穿越
  ├─ 累积: 0（不变）
  ├─ 判断: 0 == 0 → 无变化
  └─ 返回: {objects: [], total_count: 0} → ❌ 不告警

────────────────────────────────────────────

时刻 T2: 1人穿越绊线
  ├─ 检测: objects=2人
  ├─ 跟踪: trackers=2个
  ├─ 绊线: ID:5 穿越 line_1
  ├─ 累积: 0 → 1（变化！）
  ├─ 判断: 1 > 0 → 有新穿越
  └─ 返回: {objects: [2人], total_count: 2, person_count: 1} → ✅ 告警

────────────────────────────────────────────

时刻 T3: 有3人在场，但没有新穿越
  ├─ 检测: objects=3人
  ├─ 跟踪: trackers=3个
  ├─ 绊线: 无新穿越
  ├─ 累积: 1（不变）
  ├─ 判断: 1 == 1 → 无变化
  └─ 返回: {objects: [], total_count: 0} → ❌ 不告警

────────────────────────────────────────────

时刻 T4: 2人穿越绊线
  ├─ 检测: objects=3人
  ├─ 跟踪: trackers=3个
  ├─ 绊线: ID:6,ID:7 穿越 line_1
  ├─ 累积: 1 → 3（变化！）
  ├─ 判断: 3 > 1 → 有新穿越
  └─ 返回: {objects: [3人], total_count: 3, person_count: 2} → ✅ 告警
```

---

## 🔑 关键点

### 1. 判断依据：累积计数变化
```python
if 当前累积计数 > 上次记录的计数:
    ✅ 有新穿越 → 上传告警
else:
    ❌ 无新穿越 → 不上传告警
```

### 2. 返回结果差异

| 情况 | total_count | objects | person_count | 上游行为 |
|------|------------|---------|-------------|---------|
| 有新穿越 | 实际检测数 | 实际物体列表 | 新增穿越数 | ✅ 触发告警 |
| 无新穿越 | **0** | **[]** | **不存在** | ❌ 不触发告警 |

### 3. 为什么无穿越时返回空结果？

**原因：** 防止上游系统误判
- 如果返回 `total_count=2, objects=[...]` 但无 `person_count`
- 上游系统可能根据 `total_count > 0` 判断有检测结果而触发告警
- 所以要返回空结果，让上游明确知道"无事发生"

---

## 📝 日志示例

### 有新穿越时的日志

```
收到推理请求 [08:30:15]
  任务ID: 门禁统计
  批量推理完成: 26ms
  [绊线统计] ID:5 跨线 line_1 (in) -> 累加: 1
  ✅ 检测到新穿越: 0 → 1 (+1)，上传告警
     返回: total_count=2, person_count=1, objects=2
  推理完成
```

### 无新穿越时的日志

```
收到推理请求 [08:30:20]
  任务ID: 门禁统计
  批量推理完成: 25ms
  ℹ️  无新穿越（累计=1），返回空结果（不上传告警）
     返回: total_count=0, objects=[], 无person_count
  推理完成
```

---

## 🧪 验证方法

### 检查返回结果

```bash
# 发送测试请求
curl -s -X POST http://localhost:7903/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://...",
    "task_id": "测试",
    "task_type": "绊线人数统计"
  }' | jq '.result'

# 有新穿越时应该返回：
# {
#   "objects": [...],     ← 有内容
#   "total_count": 2,     ← >0
#   "person_count": 1,    ← 有这个字段
#   "line_crossing": {...}
# }

# 无新穿越时应该返回：
# {
#   "objects": [],        ← 空数组
#   "total_count": 0      ← 0
#   // 无 person_count
#   // 无 line_crossing
# }
```

---

## ⚠️ 上游系统告警判断

### ✅ 正确的判断逻辑

```python
response = call_line_crossing_api(image)

if response['success']:
    result = response['result']
    
    # 方式1：检查 person_count（推荐）
    if 'person_count' in result and result['person_count'] > 0:
        send_alarm(f"{result['person_count']}人穿越绊线")
    
    # 方式2：检查 total_count + person_count
    if result.get('total_count', 0) > 0 and 'person_count' in result:
        send_alarm()
```

### ❌ 错误的判断逻辑

```python
# 错误1：只检查 total_count
if result['total_count'] > 0:
    send_alarm()  # ❌ 会误报（即使无穿越，有人在场也告警）

# 错误2：检查 objects
if len(result['objects']) > 0:
    send_alarm()  # ❌ 会误报

# 错误3：检查 line_crossing
if 'line_crossing' in result:
    send_alarm()  # ❌ 会误报
```

---

## 🎯 告警逻辑总结

### 绊线统计服务的返回策略

```
有新穿越:
  → 返回完整检测结果
  → total_count = 实际检测数
  → objects = 实际物体列表
  → person_count = 新增穿越数（必有）
  → line_crossing = 绊线统计信息
  
无新穿越:
  → 返回空结果
  → total_count = 0
  → objects = []
  → 无 person_count
  → 无 line_crossing
```

### 为什么这样设计？

1. **明确告警意图**
   - 有 person_count → 明确表示"有新穿越，需要告警"
   - 无 person_count → 明确表示"无事发生，不要告警"

2. **避免上游误判**
   - 返回空结果（total_count=0）→ 上游明确知道"无需告警"
   - 不会因为有 objects 或 total_count > 0 而误触发告警

3. **语义清晰**
   - 空结果 = 无事发生
   - 有内容 = 发生了需要关注的事件（穿越）

---

## 🔧 如果仍然误报

### 检查上游系统的判断逻辑

```bash
# 1. 查看返回给上游的实际数据
tail -f /cv_space/predict/logs/line_crossing.log | grep "返回"

# 应该看到：
# 有穿越: 返回: total_count=2, person_count=1, objects=2
# 无穿越: 返回: total_count=0, objects=[], 无person_count
```

### 确认上游系统代码

上游系统必须这样判断：
```python
# ✅ 正确
if 'person_count' in result and result['person_count'] > 0:
    trigger_alarm()

# ❌ 错误（会导致误报）
if result['total_count'] > 0:
    trigger_alarm()
```

---

## 📞 调试命令

```bash
# 1. 查看最近的告警记录
grep -E "上传告警|不上传告警" /cv_space/predict/logs/line_crossing.log | tail -20

# 2. 查看返回结果
grep "返回:" /cv_space/predict/logs/line_crossing.log | tail -20

# 3. 验证告警逻辑
./scripts/验证告警逻辑.sh

# 4. 实时监控
./scripts/manage_logs.sh view line
```

---

现在绊线统计服务的逻辑是：
- ✅ **有新穿越** → 返回完整结果 → 上传告警
- ✅ **无新穿越** → 返回空结果 → 不上传告警

如果上游系统仍然收到误报，请检查上游的告警判断逻辑！

