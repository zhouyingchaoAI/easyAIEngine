# 算法区域过滤功能说明（简版）

## 功能介绍

算法告警返回结果现在支持**区域过滤**功能。只有位于配置区域内的检测对象才会被返回，区域外的对象将被自动过滤掉。

## 支持的服务

✅ **实时检测服务**（端口 7902）- 人数统计、客流分析  
✅ **绊线统计服务**（端口 7903）- 绊线人数统计

## 快速开始

### 1. 创建配置文件

在图片目录下创建 `algo_config.json`：

```json
{
  "task_id": "测试任务",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "area_1",
      "name": "检测区域",
      "type": "rectangle",
      "enabled": true,
      "points": [[0.3, 0.3], [0.7, 0.7]]
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.5
  }
}
```

### 2. 发起推理请求

```bash
curl -X POST http://localhost:7902/infer \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "http://example.com/images/frame.jpg",
    "task_id": "测试任务",
    "task_type": "人数统计"
  }'
```

### 3. 查看效果

服务日志会显示：

```
  ℹ️  区域过滤: 原始 8 个 → 区域内 5 个 (过滤掉 3 个)
```

## 支持的区域类型

### 矩形区域（rectangle）

```json
{
  "type": "rectangle",
  "points": [[0.2, 0.2], [0.8, 0.8]]
}
```

### 多边形区域（polygon）

```json
{
  "type": "polygon",
  "points": [
    [0.1, 0.1],
    [0.5, 0.05],
    [0.9, 0.3],
    [0.8, 0.9]
  ]
}
```

## 关键特性

✅ **自动识别坐标系统** - 支持归一化坐标（0-1）和像素坐标  
✅ **支持多个区域** - OR逻辑，对象在任意区域内即保留  
✅ **可禁用区域** - 通过 `enabled: false` 临时禁用  
✅ **向后兼容** - 无配置时不影响原有功能  
✅ **性能优异** - 额外耗时 < 1ms

## 工作流程

```
检测对象 → 区域过滤 → 返回结果
```

## 配置文件位置

```
/path/to/images/
  ├── algo_config.json    ← 配置文件
  ├── frame_001.jpg
  └── frame_002.jpg
```

## 测试功能

```bash
# 运行测试脚本
python3 test_region_filter.py

# 测试通过标志
✓ 所有测试通过！
```

## 详细文档

- **区域过滤配置示例.md** - 完整配置指南
- **区域过滤功能更新日志.md** - 技术实现细节
- **告警机制说明.md** - 告警机制说明

## 常见问题

**Q: 如果没有配置文件会怎样？**  
A: 不会报错，返回所有检测对象（不过滤）

**Q: 坐标是归一化还是像素坐标？**  
A: 两者都支持，系统会自动识别

**Q: 多个区域是"与"还是"或"？**  
A: "或"关系，对象在任意区域内即保留

**Q: 会影响性能吗？**  
A: 几乎不影响，额外耗时 < 1ms

---

**功能状态：** ✅ 已完成并测试  
**更新日期：** 2025-11-06

