# YOLOv11x 人头检测算法服务说明

## 服务概述

本项目现在提供**两个独立的算法服务**：

### 1. 实时检测算法服务 (algorithm_service.py)
- **端口**: 8501 (默认)
- **任务类型**: 人数统计、客流分析、人头检测
- **特点**: 实时检测，每次推理都返回当前检测到的人数和物体
- **启动脚本**: `./scripts/start_algorithm_service.sh`

### 2. 绊线人数统计算法服务 (algorithm_service_line_crossing.py)
- **端口**: 8502 (默认)
- **任务类型**: 绊线人数统计
- **特点**: 
  - 基于目标跟踪的绊线检测
  - 增量告警机制（只在有新跨线时触发告警）
  - 累积计数（24小时自动清零）
- **启动脚本**: `./scripts/start_line_crossing_service.sh`

---

## 服务区别

| 特性 | 实时检测服务 | 绊线统计服务 |
|------|------------|------------|
| **检测方式** | 实时检测 | 跟踪 + 绊线检测 |
| **告警方式** | 每次都返回当前检测结果 | 只在有新跨线时告警 |
| **计数方式** | 实时计数 | 累积计数 |
| **配置需求** | 无特殊要求 | 需要 algo_config.json |
| **适用场景** | 实时人数监控、客流统计 | 进出门禁、跨线计数 |

---

## 启动服务

### 方式一：使用默认配置启动

```bash
# 启动实时检测服务（端口 8501）
./scripts/start_algorithm_service.sh

# 启动绊线统计服务（端口 8502）
./scripts/start_line_crossing_service.sh
```

### 方式二：自定义配置启动

```bash
# 实时检测服务 - 自定义端口
./scripts/start_algorithm_service.sh --port 9000

# 绊线统计服务 - 自定义端口  
./scripts/start_line_crossing_service.sh --port 9001

# 不注册到 EasyDarwin
./scripts/start_algorithm_service.sh --no-register
```

---

## 实时检测服务详情

### 支持的任务类型
1. **人数统计**: 实时返回检测到的人数
2. **客流分析**: 实时客流量统计
3. **人头检测**: 检测并定位人头位置

### 返回结果示例
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 5,
    "person_count": 5  // 实时人数
  },
  "confidence": 0.87,
  "inference_time_ms": 45
}
```

### 特点
- ✅ **简单直接**: 每次推理都返回当前检测结果
- ✅ **无需配置**: 不需要额外的配置文件
- ✅ **实时响应**: 适合需要实时监控的场景

---

## 绊线统计服务详情

### 功能特性
1. **目标跟踪**: 基于IOU的目标跟踪
2. **绊线检测**: 检测目标是否跨越虚拟线段
3. **增量告警**: 只在有新跨线时触发告警
4. **累积计数**: 记录累积跨线人数（24小时自动清零）

### 配置文件要求

需要在图片目录下提供 `algo_config.json`：

```json
{
  "task_id": "厕所统计",
  "task_type": "绊线人数统计",
  "algorithm_params": {
    "confidence_threshold": 0.5,
    "iou_threshold": 0.5
  },
  "regions": [
    {
      "id": "line_1",
      "name": "进门线",
      "type": "line",
      "enabled": true,
      "points": [[0.4, 0.1], [0.4, 0.9]],
      "properties": {
        "direction": "both"
      }
    }
  ]
}
```

### 返回结果示例

**有新跨线时（触发告警）：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 2,
    "person_count": 1,  // 新增跨线人数（触发告警）
    "line_crossing": {
      "line_1": {
        "region_name": "进门线",
        "count": 15,  // 累积跨线总数
        "direction": "both"
      }
    }
  }
}
```

**无新跨线时（不触发告警）：**
```json
{
  "success": true,
  "result": {
    "objects": [...],
    "total_count": 2,
    // 无 person_count 字段（不触发告警）
    "line_crossing": {
      "line_1": {
        "count": 15
      }
    }
  }
}
```

### 增量告警机制说明

- **有新跨线** → 设置 `person_count` = 新增数量 → 上游触发告警 ✅
- **无新跨线** → 删除 `person_count` 字段 → 上游不触发告警 ⚪
- **保留检测信息** → `objects` 和 `total_count` 始终存在 → 上游能看到检测结果

详细说明请参阅：[绊线增量告警说明.md](绊线增量告警说明.md)

---

## 常见问题

### Q1: 为什么要拆分成两个服务？
**A**: 因为实时检测和绊线统计是两种完全不同的逻辑：
- 实时检测：每次都返回当前结果，适合实时监控
- 绊线统计：只在有新跨线时告警，适合累积计数

拆分后各司其职，逻辑更清晰，也更容易维护和扩展。

### Q2: 两个服务可以同时运行吗？
**A**: 可以！两个服务使用不同的端口（8501 和 8502），互不干扰。

### Q3: 如何选择使用哪个服务？
**A**: 根据业务需求选择：
- 需要**实时人数监控** → 使用实时检测服务
- 需要**进出门禁计数** → 使用绊线统计服务
- 需要**跨线累积统计** → 使用绊线统计服务

### Q4: 绊线服务是否支持多条线？
**A**: 支持！在 `algo_config.json` 的 `regions` 数组中配置多条线即可。

### Q5: 如何停止服务？
**A**: 
```bash
# 停止所有算法服务
pkill -f algorithm_service

# 停止特定服务
pkill -f algorithm_service.py          # 停止实时检测服务
pkill -f algorithm_service_line_crossing.py  # 停止绊线统计服务
```

---

## 技术支持

如有问题，请查看：
- [配置参数说明.md](配置参数说明.md)
- [绊线增量告警说明.md](绊线增量告警说明.md)
- 日志目录: `logs/`

